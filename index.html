<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Voca Han&Hyo</title>
<link rel="icon" href="logo.png"/>

<!-- ìš”ì²­í•˜ì‹  ì›¹í°íŠ¸ ì ìš© -->
<style>
@font-face {
  font-family: 'SchoolSafetyTteokbokki';
  src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2510-1@1.0/HakgyoansimTTeokbokkiB.woff2') format('woff2');
  font-weight: normal;
  font-display: swap;
}
:root{
  --primary:#58CC02; --accent:#FFD166; --accent2:#73E0A9; --accent3:#A3D5FF; --accent4:#FFB3C6;
  --text:#233042; --bg:#F7FAF7; --white:#fff;
  --ok:#58CC02; --bad:#FF6B6B; --info:#3A86FF;
  --shadow:0 6px 18px rgba(0,0,0,.08);
  --br:#E6EFE5; --br-info:#CFE0FF; --br-accent:#FFE6AE;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--text);
  font-family:'SchoolSafetyTteokbokki', system-ui, -apple-system, Segoe UI, Noto Sans KR, sans-serif;
  -webkit-tap-highlight-color: transparent;
}
.container{max-width:920px;margin:0 auto;padding:16px 16px 120px}
.hidden{display:none!important}

/* ìƒë‹¨ íƒ€ì´í‹€(í´ë¦­ ì‹œ í™ˆ ì´ë™) */
.appbar{
  position:sticky; top:0; z-index:20; background:#fff; border-bottom:1px solid #eee;
  display:flex; align-items:center; justify-content:center; gap:8px; padding:10px 12px;
  font-weight:900; font-size:22px; cursor:pointer;
}
.appbar img{width:30px;height:30px;border-radius:8px;box-shadow:var(--shadow)}

/* í™ˆ â€” ë‘ ë²„íŠ¼ì„ ëª¨ë°”ì¼ì—ì„œë„ ì¢Œìš° ë°°ì¹˜ */
.grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:18px}
.card{
  background:#fff; border-radius:16px; padding:20px; box-shadow:var(--shadow); border:1px solid var(--br);
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px;
  font-weight:800; font-size:18px; min-height:96px;
}
.card img{width:42px;height:42px; opacity:.95}

/* 30ë‹¨ê³„ ê·¸ë¦¬ë“œ â€” ë” ì‘ê²Œ */
.stage-grid{display:grid; grid-template-columns:repeat(6,1fr); gap:8px}
@media(min-width:540px){.stage-grid{grid-template-columns:repeat(8,1fr)}}
.stage{
  background:#fff; border-radius:10px; padding:10px 8px; box-shadow:var(--shadow); border:1px solid var(--br);
  display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:58px; cursor:pointer;
}
.stage h4{margin:0; font-size:14px; letter-spacing:.2px}
.stage .small{font-size:11px; opacity:.7}

/* ë¡œë”© */
.center{display:grid; place-items:center}
.spinner{width:48px;height:48px;border:5px solid #e6f4e5;border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ê³µí†µ ë·° */
.view{display:none}
.view.active{display:block}

/* ìƒë‹¨ íƒ€ì´ë¨¸ */
.timer{display:flex; align-items:center; justify-content:center; gap:8px; font-weight:800; margin:8px 0 12px}
.timebar-wrap{height:10px; background:#E3EDFF; border:1px solid var(--br-info); border-radius:999px; overflow:hidden}
.timebar{height:10px; background:linear-gradient(90deg, var(--info), #82b6ff); width:100%}

/* í•™ìŠµ ì¹´ë“œ â€” ì¤‘ì•™ ë°°ì¹˜, í° ë‹¨ì–´, ë°œìŒ ê°„ê²© ì¤„ì„ */
.study-card{
  background:#fff; border-radius:18px; padding:22px; box-shadow:var(--shadow); border:1px solid var(--br);
  min-height:340px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; text-align:center
}
.word{font-size:56px; font-weight:900; letter-spacing:.4px; cursor:pointer}
.meta{display:flex; gap:10px; align-items:center; justify-content:center; color:#556}
.meta .sep{width:4px;height:4px;border-radius:50%;background:#ccd5e0}
.meaning{background:#FFF8EC;border:1px dashed var(--br-accent);padding:12px;border-radius:12px;width:100%;font-size:16px}
.example{background:#F6FBFF;border:1px dashed var(--br-info);padding:12px;border-radius:12px;width:100%;font-size:15px}

/* í•˜ë‹¨ ê³ ì • í° ì´ì „/ë‹¤ìŒ */
.bottom-bar{
  position:fixed; left:0; right:0; bottom:0; z-index:30;
  background:linear-gradient(180deg, rgba(247,250,247,.2), #fff);
  border-top:1px solid var(--br); padding:10px 12px;
}
.bottom-row{display:grid; grid-template-columns:1fr 1fr; gap:10px; max-width:920px; margin:0 auto}
.btn{border:none; padding:16px; border-radius:14px; box-shadow:var(--shadow); font-weight:900; font-size:18px}
.btn-outline{background:#fff; color:var(--primary); border:2px solid var(--primary)}
.primary{background:var(--primary); color:#fff}

/* í€´ì¦ˆ */
.quiz-card{background:#fff;border-radius:18px;padding:18px;box-shadow:var(--shadow);border:1px solid var(--br);min-height:260px}
.quiz-q{font-weight:900;margin-bottom:6px}
.input-row{display:flex;gap:8px;margin-top:8px}
.input-row input{flex:1;padding:12px;border-radius:10px;border:1.5px solid var(--br);font-size:16px}
.input-row button{min-width:110px}
.hint{background:#FFF8EC;border:1px dashed var(--br-accent);padding:10px;border-radius:10px;font-size:14px;display:none;margin-top:8px}

/* í† ìŠ¤íŠ¸ */
.toast{
  position:fixed; bottom:20px; left:50%; transform:translateX(-50%); z-index:100;
  background:#233042; color:#fff; padding:12px 16px; border-radius:12px; box-shadow:var(--shadow); font-size:14px
}
</style>
</head>
<body>
<!-- ìƒë‹¨ ì œëª©(í´ë¦­í•˜ë©´ í™ˆ) -->
<div class="appbar" id="titleBtn"><img src="logo.png" alt="logo">Voca Han&Hyo</div>

<!-- ë¡œë”© -->
<div id="loader" class="center" style="height:60vh"><div class="spinner" aria-label="Loading"></div></div>

<!-- ì•± -->
<div id="app" class="container hidden">
  <!-- í™ˆ -->
  <section id="homeView" class="view active">
    <div class="grid2">
      <button class="card" id="goStudy"><img src="logo.png" alt=""><span>ğŸ“˜ ë‹¨ì–´ ì•”ê¸°</span></button>
      <button class="card" id="goQuiz"><img src="logo.png" alt=""><span>ğŸ“ í€´ì¦ˆ</span></button>
    </div>
  </section>

  <!-- ë‹¨ê³„ ì„ íƒ(í•™ìŠµ) -->
  <section id="studySelectView" class="view">
    <h3 style="margin:8px 0 10px">í•™ìŠµí•  ë‹¨ê³„ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
    <div class="stage-grid" id="studyStageGrid"></div>
  </section>

  <!-- ë‹¨ê³„ ì„ íƒ(í€´ì¦ˆ) -->
  <section id="quizSelectView" class="view">
    <h3 style="margin:8px 0 10px">í€´ì¦ˆí•  ë‹¨ê³„ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
    <div class="stage-grid" id="quizStageGrid"></div>
  </section>

  <!-- í•™ìŠµ -->
  <section id="studyView" class="view">
    <div class="timer"><span>ë‚¨ì€ ì‹œê°„</span><strong id="studyTime">30:00</strong></div>
    <div class="timebar-wrap"><div id="studyTimeBar" class="timebar"></div></div>

    <div class="study-card">
      <div class="word" id="sWord" title="í´ë¦­í•˜ë©´ ë°œìŒì´ ì¬ìƒë©ë‹ˆë‹¤">â€”</div>
      <div class="meta"><span id="sKpron"></span><span class="sep"></span><span id="sIpa"></span></div>
      <!-- ìš”ì²­: ëœ» â†’ ì˜ˆë¬¸ ìˆœì„œ -->
      <div class="meaning" id="sMeaning"><strong>ëœ»</strong> â€” </div>
      <div class="example" id="sExample">ì˜ˆë¬¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>
  </section>

  <!-- í€´ì¦ˆ -->
  <section id="quizView" class="view">
    <div class="timer"><span>ë‚¨ì€ ì‹œê°„</span><strong id="quizTime">30:00</strong></div>
    <div class="timebar-wrap"><div id="quizTimeBar" class="timebar"></div></div>

    <div class="quiz-card">
      <div class="quiz-q" id="qPrompt">â€”</div>
      <div class="example" id="qMeaning">â€”</div>
      <div class="input-row">
        <input id="qInput" type="text" placeholder="ì •ë‹µ ì…ë ¥"/>
        <button class="btn primary" id="qSubmit">ì œì¶œ</button>
      </div>
      <button class="btn btn-outline" id="qHintBtn" style="margin-top:8px">íŒíŠ¸ (ì˜ˆë¬¸)</button>
      <div class="hint" id="qHint">ì˜ˆë¬¸</div>
      <div style="margin-top:6px;opacity:.8;font-size:13px" id="qProgress">1 / 150</div>
    </div>
  </section>
</div>

<!-- í•™ìŠµ í•˜ë‹¨ ê³ ì • ë²„íŠ¼ -->
<div id="studyBottom" class="bottom-bar hidden">
  <div class="bottom-row">
    <button class="btn btn-outline" id="prevBtn">â† ì´ì „</button>
    <button class="btn primary" id="nextBtn">ë‹¤ìŒ â†’</button>
  </div>
</div>

<div id="toast" class="toast hidden"></div>

<!-- SheetJS (xlsx) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
(() => {
  // ====== ì„¤ì • ìƒìˆ˜ (ê²½ë¡œë§Œ ë°”ê¿”ì„œ ì‚¬ìš©)
  const WORDS_XLSX_URL = "./word_list.xlsx";   // ê°™ì€ ë¦¬í¬/í´ë”ë©´ ê·¸ëŒ€ë¡œ OK
  const PER = 150, STAGES = 30;
  const FETCH_TIMEOUT_MS = 7000;

  // ====== ìƒíƒœ
  const App = { data: [], demo:false, currentStage:1 };

  // ====== ìœ í‹¸
  const el = id => document.getElementById(id);
  const fmtTime = s => { const m=Math.floor(s/60), ss=s%60; return `${m.toString().padStart(2,'0')}:${ss.toString().padStart(2,'0')}`; };
  const clamp = (n,a,b) => Math.max(a, Math.min(b, n));
  const maskWord = (text, word) => {
    if(!text || !word) return text||'';
    const esc = word.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    return text.replace(new RegExp(esc,'gi'), m=>'â–ˆ'.repeat(Math.max(4, m.length)));
  };
  const Toast = (m,ms=2200)=>{ const t=el('toast'); t.textContent=m; t.classList.remove('hidden'); clearTimeout(Toast._t); Toast._t=setTimeout(()=>t.classList.add('hidden'),ms); };
  const speak = w => { if(!w || !('speechSynthesis' in window)) return; try{ const u=new SpeechSynthesisUtterance(w); u.lang='en-US'; u.rate=0.95; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);}catch(e){} };

  // ====== ìŠ¤í† ë¦¬ì§€(ì§„ë„/ì˜¤ë‹µë§Œ ì €ì¥)
  const Storage = {
    get(k, d=null){ try{ const v=localStorage.getItem(k); return v? JSON.parse(v): d; }catch(e){ return d; } },
    set(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} },
    keyStudy(n){ return `voca.stage.${n}.study`; },
    keyQuiz(n){ return `voca.stage.${n}.quiz`; }
  };

  // ====== ë°ì´í„° ë¡œë”
  const DataLoader = {
    async load(){
      if(typeof XLSX==='undefined') throw new Error('SheetJS ë¡œë“œ ì‹¤íŒ¨');
      const ctrl = new AbortController();
      const tm = setTimeout(()=>ctrl.abort('timeout'), FETCH_TIMEOUT_MS);
      let resp; try{ resp = await fetch(WORDS_XLSX_URL, {signal:ctrl.signal}); } finally { clearTimeout(tm); }
      if(!resp || !resp.ok) throw new Error('ì—‘ì…€ ì‘ë‹µ ì˜¤ë¥˜');
      const ab = await resp.arrayBuffer();
      const wb = XLSX.read(ab,{type:'array'});
      const sheet = wb.Sheets[wb.SheetNames[0]];
      let rows = XLSX.utils.sheet_to_json(sheet,{header:1,defval:""});
      // í—¤ë” ìë™ ê°ì§€
      const hdr = rows[0]||[]; const hs = new Set(hdr.map(v=>String(v).trim().toLowerCase()));
      const hasHeader = hs.has('word') || hs.has('meaning_ko') || hs.has('ipa') || hs.has('example');
      if(hasHeader) rows = rows.slice(1);
      const out=[];
      for(const r of rows){
        const word = (r[0]||"").toString().trim();
        if(!word) continue;
        out.push({
          word,
          meaning_ko:(r[1]||"").toString().trim(),
          korean_pron:(r[2]||"").toString().trim(),
          ipa:(r[3]||"").toString().trim(),
          example:(r[4]||"").toString().trim(),
        });
      }
      if(out.length<1) throw new Error('ì—‘ì…€ íŒŒì‹± ê²°ê³¼ ì—†ìŒ');
      return out;
    },
    demo(){
      App.demo=true;
      return [
        {word:'abandon', meaning_ko:'ë²„ë¦¬ë‹¤, í¬ê¸°í•˜ë‹¤', korean_pron:'ì–´ë°´ë˜', ipa:'É™ËˆbÃ¦ndÉ™n', example:'He had to abandon the plan.'},
        {word:'ability', meaning_ko:'ëŠ¥ë ¥', korean_pron:'ì–´ë¹Œë¦¬í‹°', ipa:'É™ËˆbÉªlÉ™ti', example:'She has the ability to lead.'},
        {word:'ban', meaning_ko:'ê¸ˆì§€í•˜ë‹¤', korean_pron:'ë°´', ipa:'bÃ¦n', example:'They plan to ban smoking here.'},
        {word:'capture', meaning_ko:'í¬íší•˜ë‹¤, ë¶™ì¡ë‹¤', korean_pron:'ìº¡ì²˜', ipa:'ËˆkÃ¦ptÊƒÉ™r', example:'The photo captures the moment.'},
        {word:'demand', meaning_ko:'ìš”êµ¬í•˜ë‹¤', korean_pron:'ë””ë§¨ë“œ', ipa:'dÉªËˆmÃ¦nd', example:'They demand better pay.'},
        {word:'eager', meaning_ko:'ì—´ë§í•˜ëŠ”', korean_pron:'ì´ê±°', ipa:'ËˆiËÉ¡É™r', example:'He is eager to learn.'},
        {word:'fabric', meaning_ko:'ì§ë¬¼, êµ¬ì¡°', korean_pron:'íŒ¨ë¸Œë¦­', ipa:'ËˆfÃ¦brÉªk', example:'This fabric is soft.'},
        {word:'genuine', meaning_ko:'ì§„ì§œì˜', korean_pron:'ì œë‰´ì¸', ipa:'ËˆdÊ’enjuÉªn', example:'Is this leather genuine?'},
        {word:'habit', meaning_ko:'ìŠµê´€', korean_pron:'í•´ë¹—', ipa:'ËˆhÃ¦bÉªt', example:'He has a habit of reading.'},
        {word:'ideal', meaning_ko:'ì´ìƒì ì¸', korean_pron:'ì•„ì´ë””ì–¼', ipa:'aÉªËˆdiËÉ™l', example:'It was an ideal place to rest.'},
      ];
    }
  };

  // ====== ê³µí†µ
  const sliceStage = s => { const st=(s-1)*PER; return App.data.slice(st, st+PER); };
  const buildStageGrid = (target, onClick) => {
    target.innerHTML='';
    for(let i=1;i<=STAGES;i++){
      const start=(i-1)*PER+1, end=i*PER;
      const b=document.createElement('button');
      b.className='stage';
      b.innerHTML=`<h4>${String(i).padStart(2,'0')}</h4><div class="small">${start}â€“${end}</div>`;
      b.onclick=()=>onClick(i);
      target.appendChild(b);
    }
  };
  const switchView = v => { document.querySelectorAll('.view').forEach(x=>x.classList.remove('active')); v.classList.add('active'); window.scrollTo({top:0,behavior:'smooth'}); };

  // ====== í•™ìŠµ
  let sIndex=0, sTimer=null, sRemain=1800;
  const studyTime = el('studyTime'), studyTimeBar = el('studyTimeBar');
  const sWord = el('sWord'), sKpron = el('sKpron'), sIpa = el('sIpa'), sMeaning = el('sMeaning'), sExample = el('sExample');

  function startStudy(stage){
    App.currentStage = stage;
    const list = sliceStage(stage);
    if(list.length===0){ Toast('ì´ ë‹¨ê³„ì— ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
    const st = Storage.get(Storage.keyStudy(stage), {index:0});
    sIndex = clamp(st.index||0, 0, list.length-1);
    el('studyBottom').classList.remove('hidden');
    switchView(el('studyView'));
    resetTimer('study');   // ì§„ì… ì¦‰ì‹œ 30ë¶„ ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
    renderStudy();
  }
  function renderStudy(){
    const list = sliceStage(App.currentStage);
    const it = list[sIndex];
    studyTime.textContent = fmtTime(sRemain);
    sWord.textContent = it.word || 'â€”';
    sKpron.textContent = it.korean_pron || '';
    sIpa.textContent = it.ipa || '';
    sMeaning.innerHTML = '<strong>ëœ»</strong> â€” ' + (it.meaning_ko || 'â€”');
    sExample.innerHTML = it.example ? it.example : 'ì˜ˆë¬¸ ì—†ìŒ';
    Storage.set(Storage.keyStudy(App.currentStage), {index:sIndex});
  }
  function nextStudy(dir){
    const list = sliceStage(App.currentStage);
    sIndex = (sIndex + dir + list.length) % list.length;
    renderStudy();
  }
  sWord.addEventListener('click', ()=> speak(sWord.textContent));
  el('prevBtn').addEventListener('click', ()=> nextStudy(-1));
  el('nextBtn').addEventListener('click', ()=> nextStudy(1));

  // ====== í€´ì¦ˆ (í•œ/ì˜ ëœë¤, ì½¤ë§ˆ ê¸°ì¤€ í•˜ë‚˜ë§Œ ì •ë‹µ ì¸ì •)
  let qIndex=0, qTimer=null, qRemain=1800, quizList=[], qWrong=[];
  const quizTime=el('quizTime'), quizTimeBar=el('quizTimeBar');
  const qPrompt=el('qPrompt'), qMeaning=el('qMeaning'), qHint=el('qHint'), qHintBtn=el('qHintBtn'), qInput=el('qInput');

  function startQuiz(stage, onlyWrong=false){
    App.currentStage=stage;
    const full = sliceStage(stage);
    if(onlyWrong){ const prev = Storage.get(Storage.keyQuiz(stage), {wrong:[]}).wrong; quizList = prev.length? prev : []; }
    else quizList = full;
    if(quizList.length===0){ Toast('í€´ì¦ˆì— ì‚¬ìš©í•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
    qIndex=0; qWrong=[];
    switchView(el('quizView'));
    resetTimer('quiz');
    renderQuestion();
  }
  function renderQuestion(){
    const it = quizList[qIndex];
    // 0: KOâ†’EN (ëœ»ì„ ë³´ê³  ì˜ë‹¨ì–´), 1: ENâ†’KO (ì˜ë‹¨ì–´ ë³´ê³  ëœ» í•˜ë‚˜)
    const type = Math.random()<0.5?0:1;
    qInput.dataset.type = String(type);
    qInput.value=''; qHint.style.display='none';

    if(type===0){
      qPrompt.textContent='ëœ»ì„ ë³´ê³  ì˜ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”';
      qMeaning.textContent = it.meaning_ko || 'ëœ» ì •ë³´ ì—†ìŒ';
      qHint.textContent = maskWord(it.example||'ì˜ˆë¬¸ ì—†ìŒ', it.word||'');
    }else{
      qPrompt.textContent='ì˜ë‹¨ì–´ë¥¼ ë³´ê³  ëœ»(í•˜ë‚˜ë§Œ) ì…ë ¥í•˜ì„¸ìš”';
      qMeaning.textContent = it.word || '-';
      qHint.textContent = it.example || 'ì˜ˆë¬¸ ì—†ìŒ';
    }
    el('qProgress').textContent = `${qIndex+1} / ${quizList.length}`;
    qInput.focus();
  }
  const normEn = s => (s||'').toLowerCase().replace(/[^a-z]/g,'');
  const normKo = s => (s||'').trim().replace(/\s+/g,''); // ê³µë°± ì œê±°ë§Œ
  el('qSubmit').addEventListener('click', ()=>{
    const it = quizList[qIndex];
    const t = Number(qInput.dataset.type)||0;
    const user = qInput.value||'';
    let ok=false;

    if(t===0){ // KOâ†’EN
      ok = normEn(user) === normEn(it.word||'');
    }else{     // ENâ†’KO (ì½¤ë§ˆ êµ¬ë¶„ í•­ëª© ì¤‘ í•˜ë‚˜ë§Œ ë§ì•„ë„ OK)
      const pick = normKo(user);
      const answers = (it.meaning_ko||'').split(',').map(a=>normKo(a)).filter(Boolean);
      ok = answers.some(a => pick===a || a.includes(pick) || pick.includes(a));
    }

    if(ok) Toast('ì •ë‹µ!');
    else { Toast(`ì˜¤ë‹µ: ${t===0 ? it.word : (it.meaning_ko||'-')}`); qWrong.push(it); }
    qIndex++;
    if(qIndex<quizList.length) renderQuestion();
    else {
      Storage.set(Storage.keyQuiz(App.currentStage), {wrong:qWrong.map(x=>({word:x.word,meaning_ko:x.meaning_ko,example:x.example||''}))});
      Toast('í€´ì¦ˆ ì¢…ë£Œ!');
    }
  });
  qInput.addEventListener('keydown', e=>{ if(e.key==='Enter') el('qSubmit').click(); });
  qHintBtn.addEventListener('click', ()=>{ qHint.style.display = (qHint.style.display==='none'||!qHint.style.display)?'block':'none'; });

  // ====== íƒ€ì´ë¨¸(í•™ìŠµ/í€´ì¦ˆ ê°ê° 30ë¶„, ì§„ì… ì¦‰ì‹œ ì‹œì‘)
  function resetTimer(which){
    if(which==='study'){
      if(sTimer) clearInterval(sTimer);
      sRemain=1800; studyTime.textContent=fmtTime(sRemain); studyTimeBar.style.width='100%';
      sTimer=setInterval(()=>{ sRemain--; if(sRemain<0){clearInterval(sTimer); sTimer=null; Toast('í•™ìŠµ ì‹œê°„ ì¢…ë£Œ'); return;}
        studyTime.textContent=fmtTime(sRemain); studyTimeBar.style.width=`${sRemain/1800*100}%`; },1000);
    }else{
      if(qTimer) clearInterval(qTimer);
      qRemain=1800; quizTime.textContent=fmtTime(qRemain); quizTimeBar.style.width='100%';
      qTimer=setInterval(()=>{ qRemain--; if(qRemain<0){clearInterval(qTimer); qTimer=null; Toast('í€´ì¦ˆ ì‹œê°„ ì¢…ë£Œ'); return;}
        quizTime.textContent=fmtTime(qRemain); quizTimeBar.style.width=`${qRemain/1800*100}%`; },1000);
    }
  }

  // ====== ë‚´ë¹„ê²Œì´ì…˜
  el('titleBtn').addEventListener('click', ()=>{ switchView(el('homeView')); el('studyBottom').classList.add('hidden'); });
  el('goStudy').addEventListener('click', ()=> switchView(el('studySelectView')));
  el('goQuiz').addEventListener('click', ()=> switchView(el('quizSelectView')));

  // í•˜ë‹¨ í° ë²„íŠ¼ì€ í•™ìŠµ í™”ë©´ì—ì„œë§Œ ë…¸ì¶œ
  el('prevBtn').addEventListener('click', ()=> nextStudy(-1));
  el('nextBtn').addEventListener('click', ()=> nextStudy(1));

  // ====== ì´ˆê¸°í™”
  async function init(){
    try{ App.data = await DataLoader.load(); App.demo=false; }
    catch(e){ console.warn(e); App.data = DataLoader.demo(); Toast('ì—‘ì…€ ë¡œë“œ ì‹¤íŒ¨ â€” ë°ëª¨ ëª¨ë“œë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.'); }
    finally{
      buildStageGrid(el('studyStageGrid'), startStudy);
      buildStageGrid(el('quizStageGrid'),  startQuiz);
      el('loader').classList.add('hidden'); el('app').classList.remove('hidden');
    }
  }
  init();
})();
</script>
</body>
</html>