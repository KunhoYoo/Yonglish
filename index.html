<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Voca Han&Hyo</title>
<link rel="icon" href="logo.png"/>

<style>
@font-face{
  font-family:'GabiaSai';
  src:url('https://cdn.jsdelivr.net/gh/projectnoonnu/2510-1@1.0/GabiaSai-Regular.woff2') format('woff2');
  font-weight:normal;font-display:swap;
}
:root{
  --primary:#58CC02; --accent:#FFD166; --info:#3A86FF;
  --good:#A7E9AF; --bad:#F7A8A8; --bg:#F7FAF7; --text:#233042;
  --br:#E6EFE5; --shadow:0 6px 18px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:'GabiaSai',system-ui,-apple-system,Segoe UI,Noto Sans KR,sans-serif}
.container{max-width:900px;margin:0 auto;padding:16px 16px 120px}
.hidden{display:none!important}
.center{display:grid;place-items:center}
.spinner{width:48px;height:48px;border:5px solid #e6f4e5;border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.appbar{position:sticky;top:0;z-index:20;display:flex;align-items:center;justify-content:center;background:#fff;border-bottom:1px solid #eee;font-size:22px;font-weight:800;padding:10px;cursor:pointer}
.view{display:none}.view.active{display:block}

/* Home */
.home-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:70vh;text-align:center}
.home-logo img{width:180px;height:180px;margin-bottom:18px;border-radius:24px;box-shadow:var(--shadow)}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;width:100%;max-width:460px}
.card{
  background:#fff;border-radius:16px;padding:18px;box-shadow:var(--shadow);border:1px solid var(--br);
  display:inline-flex;align-items:center;justify-content:center;gap:10px;width:100%;cursor:pointer
}
.card .ico{font-size:28px;line-height:1}
.card .label{
  font-weight:900;
  /* ÌôîÎ©¥ Ï¢ÅÏïÑÏ†∏ÎèÑ Ìïú Ï§Ñ Ïú†ÏßÄ + ÏûêÎèô Ï∂ïÏÜå */
  font-size:clamp(18px,4.8vw,26px);
  white-space:nowrap;line-height:1
}

/* Stage select */
.stage-wrap{max-width:520px;margin:0 auto;min-height:70vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center}
.stage-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;width:100%}
.stage{background:#fff;border-radius:10px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,.06);border:1px solid var(--br);font-size:15px;cursor:pointer;min-height:56px;width:100%}
.flag-row{display:flex;gap:10px;justify-content:center;align-items:center;margin-top:14px}
.flag{border:1px solid var(--br);background:#fff;box-shadow:var(--shadow);padding:8px 12px;border-radius:12px;cursor:pointer}
.flag.active{outline:3px solid var(--primary)}

/* Timer + feedback */
.timer-area{margin:6px 0 10px}
.timer{text-align:center;font-weight:800;font-size:15px}
.timebar-wrap{height:10px;background:#E3EDFF;border:1px solid #CFE0FF;border-radius:999px;overflow:hidden;margin-top:6px}
.timebar{height:10px;background:linear-gradient(90deg,var(--info),#80b7ff);width:100%}
.feedback-slot{height:40px;display:flex;align-items:center;justify-content:center;margin-top:8px}
.feedback{visibility:hidden;opacity:0;transition:opacity .18s;max-width:520px;padding:8px 12px;border-radius:12px;box-shadow:var(--shadow);font-weight:800;font-size:14px;text-align:center}
.feedback.ok{background:#eaf8e0;color:#2d7d00;border:1px solid #cdecbc}
.feedback.bad{background:#ffe7ea;color:#b33444;border:1px solid #ffc8d0}
.feedback.show{visibility:visible;opacity:1}

/* Study */
.study-card{background:#fff;border-radius:16px;padding:22px;border:1px solid var(--br);box-shadow:var(--shadow);text-align:center;min-height:360px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px}
.word-index{font-size:13px;opacity:.7}
.word-wrap{width:100%;display:flex;align-items:center;justify-content:center;min-height:80px}
.word{font-weight:900;cursor:pointer;line-height:1.05;white-space:nowrap;max-width:100%;font-size:68px}
.meta{display:flex;gap:10px;align-items:center;justify-content:center;color:#555;font-size:16px}
.meaning{background:#FFF8EC;border:1px dashed #FFD166;padding:12px;border-radius:12px;width:100%;font-size:16px}
.example{background:#F6FBFF;border:1px dashed #CFE0FF;padding:12px;border-radius:12px;width:100%;font-size:15px;line-height:1.6;min-height:78px;display:flex;align-items:center;justify-content:center;text-align:center}
.tts-row{width:100%}
.tts-btn{border:none;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer;box-shadow:var(--shadow);background:#fff;border:1px solid var(--br);width:100%}

/* Bottom bar (Study) */
.bottom-bar{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #eee;display:flex;gap:10px;padding:10px 16px}
.bottom-bar button{flex:1;border:none;border-radius:14px;padding:14px;font-size:18px;font-weight:800;box-shadow:var(--shadow);cursor:pointer}
.prev-btn{background:#fff;color:var(--primary);border:2px solid var(--primary)}
.next-btn{background:var(--primary);color:#fff}

/* Quiz */
.quiz-wrap{display:flex;align-items:center;justify-content:center;min-height:60vh}
.quiz-card{position:relative;background:#fff;border-radius:16px;border:1px solid var(--br);box-shadow:var(--shadow);
padding:22px;max-width:520px;width:100%;text-align:center;overflow:hidden;transition:transform .15s;will-change:transform}
.q-target-wrap{width:100%;display:flex;align-items:center;justify-content:center;min-height:90px}
.q-target{font-weight:900;line-height:1.1;max-width:100%;white-space:nowrap;font-size:54px}
.input-row{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:10px}
.input-row input{flex:1;padding:12px 14px;border:1px solid #ccc;border-radius:12px;font-size:17px}

/* Buttons (bigger) */
.btn-sm{flex:1;border:none;border-radius:12px;padding:14px 0;font-weight:700;font-size:18px;cursor:pointer;transition:.2s}
.btn-submit{background:#58CC02;color:#fff}
.btn-hint{background:#FFD166;color:#222}

/* Hint */
.hint{background:#FFF8EC;border:1px dashed #FFD166;padding:10px;border-radius:10px;margin-top:12px;font-size:14px;display:none}

/* Shake + Flash effects */
@keyframes shake{0%,100%{transform:translateX(0);}20%,60%{transform:translateX(-9px);}40%,80%{transform:translateX(9px);}}
.shake{animation:shake .45s ease}
.quiz-card.flash-correct{animation:flashGreen .7s ease}
@keyframes flashGreen{
  0%{background:#fff;}
  25%{background:#d4f8c4;}
  50%{background:#c3f2b2;}
  75%{background:#d4f8c4;}
  100%{background:#fff;}
}

/* Stars */
.star{position:absolute;pointer-events:none;opacity:0;transform:scale(.6);animation:pop .8s ease forwards}
@keyframes pop{0%{opacity:0;transform:translateY(10px) scale(.6)}10%{opacity:1;transform:translateY(0) scale(1)}80%{opacity:1}100%{opacity:0;transform:translateY(-20px) scale(1.1)}}

/* Result */
.result-wrap{display:flex;align-items:center;justify-content:center;min-height:60vh}
.result-card{background:#fff;border-radius:16px;border:1px solid var(--br);box-shadow:var(--shadow);padding:22px;max-width:560px;width:100%;text-align:center}
canvas{max-width:260px;width:100%;height:auto}
.badge{padding:8px 12px;border-radius:10px;border:1px solid var(--br);background:#f9fbf9}
.btn-row{display:flex;gap:10px;justify-content:center;margin-top:12px;flex-wrap:wrap}
.btn{border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;box-shadow:var(--shadow);background:#fff;border:1px solid var(--br)}
.btn-primary{background:var(--primary);color:#fff;border:none}
</style>
</head>
<body>
<div class="appbar" id="titleBtn">Voca Han&Hyo</div>

<!-- Loader -->
<div id="loader" class="center" style="height:60vh"><div class="spinner"></div></div>

<div id="app" class="container hidden">
  <!-- Home -->
  <section id="homeView" class="view active">
    <div class="home-wrap">
      <div class="home-logo"><img src="logo.png" alt="logo"></div>
      <div class="grid2">
        <button class="card" id="goStudy"><span class="ico">üìò</span><span class="label">STUDY</span></button>
        <button class="card" id="goQuiz"><span class="ico">üìù</span><span class="label">QUIZ</span></button>
      </div>
    </div>
  </section>

  <!-- Stage Selects -->
  <section id="studySelectView" class="view">
    <div class="stage-wrap">
      <h3>Choose a Stage</h3>
      <div class="stage-grid" id="studyStageGrid"></div>
      <div class="flag-row">
        <button class="flag" id="flagUS">üá∫üá∏ US</button>
        <button class="flag" id="flagUK">üá¨üáß UK</button>
      </div>
    </div>
  </section>
  <section id="quizSelectView" class="view">
    <div class="stage-wrap">
      <h3>Choose a Stage</h3>
      <div class="stage-grid" id="quizStageGrid"></div>
    </div>
  </section>

  <!-- Study -->
  <section id="studyView" class="view">
    <div class="timer-area">
      <div class="timer" id="studyTimer">ÎÇ®ÏùÄ ÏãúÍ∞Ñ: 30:00</div>
      <div class="timebar-wrap"><div id="studyBar" class="timebar"></div></div>
      <div class="feedback-slot"><div id="studyFeedback" class="feedback"></div></div>
    </div>
    <div class="study-card">
      <div class="word-index" id="wordIndex">1/150</div>
      <div class="word-wrap"><div class="word" id="sWord" title="ÌÉ≠ÌïòÎ©¥ Î∞úÏùå">word</div></div>
      <div class="meta"><span id="sPron"></span><span id="sIpa"></span></div>
      <div class="meaning" id="sMeaning"></div>
      <div class="example" id="sExample">‚Äî</div>
      <div class="tts-row"><button class="tts-btn" id="playTts">üîä Î∞úÏùå Îì£Í∏∞</button></div>
    </div>
  </section>

  <!-- Quiz -->
  <section id="quizView" class="view">
    <div class="timer-area">
      <div class="timer" id="quizTimer">ÎÇ®ÏùÄ ÏãúÍ∞Ñ: 30:00</div>
      <div class="timebar-wrap"><div id="quizBar" class="timebar"></div></div>
      <div class="feedback-slot"><div id="quizFeedback" class="feedback"></div></div>
    </div>
    <div class="quiz-wrap">
      <div class="quiz-card" id="quizCard">
        <div class="quiz-progress" id="qProgress">1/150</div>
        <div class="q-target-wrap"><div class="q-target" id="qTarget">‚Äî</div></div>
        <div class="input-row">
          <input id="qInput" placeholder="Ï†ïÎãµ ÏûÖÎ†•"/>
        </div>
        <div class="input-row">
          <button class="btn-sm btn-submit" id="qSubmit">Ï†úÏ∂ú</button>
          <button class="btn-sm btn-hint" id="qHintBtn">ÌûåÌä∏</button>
        </div>
        <div class="hint" id="qHint">ÏòàÎ¨∏</div>
      </div>
    </div>
  </section>

  <!-- Quiz Result -->
  <section id="quizResultView" class="view">
    <div class="result-wrap">
      <div class="result-card">
        <h3>ÌÄ¥Ï¶à Í≤∞Í≥º</h3>
        <canvas id="resultChart" width="260" height="260"></canvas>
        <div style="display:flex;gap:12px;justify-content:center;margin:10px 0">
          <div class="badge">ÎßûÏùÄ Í∞úÏàò: <strong id="resCorrect">0</strong></div>
          <div class="badge">ÌãÄÎ¶∞ Í∞úÏàò: <strong id="resWrong">0</strong></div>
          <div class="badge">Ï¥ù Î¨∏Ìï≠: <strong id="resTotal">150</strong></div>
        </div>
        <div class="btn-row">
          <button class="btn" id="btnDownloadWrong">üìÑ Ïò§ÎãµÎÖ∏Ìä∏ Îã§Ïö¥Î°úÎìú</button>
          <button class="btn btn-primary" id="btnRetryWrong">üîÅ Ïò§Îãµ Ïû¨ÌíÄÏù¥</button>
          <button class="btn" id="btnGoHome">üè† ÌôàÏúºÎ°ú</button>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Bottom Prev/Next (Study) -->
<div class="bottom-bar hidden" id="bottomBar">
  <button class="prev-btn" id="prevBtn">‚Üê Ïù¥Ï†Ñ</button>
  <button class="next-btn" id="nextBtn">Îã§Ïùå ‚Üí</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
/* ===== helpers ===== */
const el=id=>document.getElementById(id);
const fmt=s=>`${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
function switchView(v){document.querySelectorAll('.view').forEach(x=>x.classList.remove('active')); v.classList.add('active'); window.scrollTo({top:0});}
function feedback(node,ok,msg){node.textContent=msg||(ok?'Ï†ïÎãµ!':'Ïò§Îãµ');node.classList.remove('ok','bad','show');node.classList.add(ok?'ok':'bad','show');clearTimeout(node._t);node._t=setTimeout(()=>node.classList.remove('show'),1200);}

/* ===== sound files (relative paths) ===== */
const sounds={
  correct:new Audio('sounds/correct.wav'),
  wrong:new Audio('sounds/wrong.wav'),
  continuous:new Audio('sounds/continuous.wav')
};
Object.values(sounds).forEach(a=>{try{a.preload='auto';a.volume=0.9;}catch(e){}});
function playSound(type){try{const a=sounds[type]; if(a){a.currentTime=0; a.play().catch(()=>{});}}catch(e){}}

/* ===== stars ===== */
function burstStars(container,count=6){
  for(let i=0;i<count;i++){
    const s=document.createElement('div');s.className='star';s.textContent='‚≠ê';
    const x=20+Math.random()*60, y=20+Math.random()*40;
    s.style.left=x+'%'; s.style.top=y+'%'; s.style.fontSize=(18+Math.random()*8)+'px';
    container.appendChild(s); setTimeout(()=>s.remove(),800);
  }
}

/* ===== TTS ===== */
let ttsUnlocked=false;
if('speechSynthesis' in window){
  window.speechSynthesis.onvoiceschanged=()=>{};
  ['click','touchstart'].forEach(ev=>window.addEventListener(ev,()=>{ if(!ttsUnlocked){ try{const u=new SpeechSynthesisUtterance(' ');u.volume=0;speechSynthesis.speak(u);speechSynthesis.resume();ttsUnlocked=true;}catch{}} },{capture:true}));
}
const Settings={ttsLang:'en-US'};
function updateFlagUI(){el('flagUS')?.classList.toggle('active',Settings.ttsLang==='en-US');el('flagUK')?.classList.toggle('active',Settings.ttsLang==='en-GB');}
function speak(text){if(!text||!('speechSynthesis'in window))return;const u=new SpeechSynthesisUtterance(text);u.lang=Settings.ttsLang;try{speechSynthesis.cancel();setTimeout(()=>speechSynthesis.speak(u),30);}catch{}}

/* ===== Data/Stage ===== */
const PER=150, STAGES=30, WORDS_XLSX_URL='./word_list.xlsx';
let data=[], stage=1, idx=0, timer=null, remain=1800;

/* Stage grids */
function buildStageGrid(container, onClick){container.innerHTML='';for(let i=1;i<=STAGES;i++){const b=document.createElement('button');b.className='stage';b.textContent=String(i).padStart(2,'0');b.onclick=()=>onClick(i);container.appendChild(b);}}

/* Excel loader */
async function loadExcel(){
  try{
    const r=await fetch(WORDS_XLSX_URL,{cache:'no-store'});
    if(!r.ok) throw new Error('xlsx '+r.status);
    const ab=await r.arrayBuffer();
    const wb=XLSX.read(ab,{type:'array'});
    const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1,defval:""});
    const hdr=rows[0]||[]; const hs=new Set(hdr.map(v=>String(v).trim().toLowerCase()));
    const body=(hs.has('word')||hs.has('meaning_ko'))? rows.slice(1): rows;
    return body.map(r=>({word:(r[0]||'').toString().trim(),meaning:(r[1]||'').toString().trim(),pron:(r[2]||'').toString().trim(),ipa:(r[3]||'').toString().trim(),ex:(r[4]||'').toString().trim()})).filter(x=>x.word);
  }catch(e){
    console.warn('XLSX load failed, use demo.', e);
    return [
      {word:'enthusiastic',meaning:'Ïó¥Í¥ëÏ†ÅÏù∏, Ïó¥Î†¨Ìïú',pron:'',ipa:'',ex:'The audience was enthusiastic about the presentation.'},
      {word:'abandon',meaning:'Î≤ÑÎ¶¨Îã§, Ìè¨Í∏∞ÌïòÎã§',pron:'',ipa:'',ex:'He had to abandon the plan.'},
      {word:'ability',meaning:'Îä•Î†•',pron:'',ipa:'',ex:'She has the ability to lead.'}
    ];
  }
}

/* Timer with bar */
function startTimer(labelId, barId){
  if(timer) clearInterval(timer);
  remain=1800; const t=el(labelId), bar=el(barId);
  t.textContent='ÎÇ®ÏùÄ ÏãúÍ∞Ñ: '+fmt(remain); bar.style.width='100%';
  timer=setInterval(()=>{remain--; t.textContent='ÎÇ®ÏùÄ ÏãúÍ∞Ñ: '+fmt(remain); bar.style.width=(remain/1800*100)+'%'; if(remain<=0) clearInterval(timer);},1000);
}

/* ===== Study ===== */
function startStudy(n){stage=n; idx=0; el('bottomBar').classList.remove('hidden'); switchView(el('studyView')); startTimer('studyTimer','studyBar'); renderStudy();}
function fitWord(){const w=el('sWord'); let size=68,min=28; w.style.fontSize=size+'px'; const p=w.parentElement; while((w.scrollWidth>p.clientWidth*0.92||w.scrollHeight>80)&&size>min){size-=2; w.style.fontSize=size+'px';}}
function renderStudy(){const list=data.slice((stage-1)*PER, stage*PER); const it=list[idx]; if(!it) return; el('wordIndex').textContent=`${idx+1}/${list.length}`; el('sWord').textContent=it.word; el('sPron').textContent=it.pron||''; el('sIpa').textContent=it.ipa||''; el('sMeaning').textContent=it.meaning||''; el('sExample').textContent=it.ex||''; requestAnimationFrame(fitWord);}
el('sWord').onclick=()=>speak(el('sWord').textContent);
el('sExample').onclick=()=>speak(el('sExample').textContent);
el('playTts').onclick=()=>speak(el('sWord').textContent);
el('prevBtn').onclick=()=>{idx=Math.max(0,idx-1);renderStudy();};
el('nextBtn').onclick=()=>{idx++;renderStudy();};

/* ===== Quiz ===== */
let quizList=[], quizStats={total:0,correct:0,wrong:0,wrongItems:[]}, qMode='KO2EN', qItem=null, streak=0;
function startQuiz(n){stage=n; quizList=data.slice((stage-1)*PER, stage*PER); startQuizWithList(quizList);}
function resetCardEffects(){ const card=el('quizCard'); card.classList.remove('flash-correct','shake'); el('qInput').classList.remove('shake'); }
function startQuizWithList(list){
  quizList=list.slice(); idx=0; streak=0;
  quizStats={total:quizList.length,correct:0,wrong:0,wrongItems:[]};
  el('bottomBar').classList.add('hidden');
  switchView(el('quizView'));
  startTimer('quizTimer','quizBar');
  resetCardEffects();
  renderQuiz();
}
function normalizeKoPieces(s){return (s||'').split(',').map(x=>x.replace(/\s+/g,'')).filter(Boolean);}
function fitQuizTarget(){const t=el('qTarget'); let size=54,min=20; t.style.fontSize=size+'px'; const wrap=t.parentElement; while((t.scrollWidth>wrap.clientWidth*0.95 || t.scrollHeight>wrap.clientHeight) && size>min){ size-=2; t.style.fontSize=size+'px'; }}
function renderQuiz(){
  resetCardEffects();
  const it=quizList[idx];
  if(!it){ if(timer) clearInterval(timer); showQuizResult(); return; }
  qItem=it; qMode=Math.random()<0.5?'KO2EN':'EN2KO';
  el('qProgress').textContent=`${idx+1}/${quizList.length}`;
  el('qInput').value=''; el('qHint').style.display='none';
  el('qTarget').textContent = qMode==='KO2EN' ? (it.meaning||'Îúª Ï†ïÎ≥¥ ÏóÜÏùå') : (it.word||'-');
  el('qHint').textContent=it.ex||'ÏòàÎ¨∏ ÏóÜÏùå';
  requestAnimationFrame(fitQuizTarget);
}
el('qHintBtn').onclick=()=>{const h=el('qHint'); h.style.display=h.style.display==='none'?'block':'none';};

function submitQuiz(){
  if(!qItem) return;
  const raw=(el('qInput').value||'').trim();
  const card=el('quizCard');
  let ok=false;
  if(qMode==='KO2EN'){ const user=raw.toLowerCase().replace(/[^a-z]/g,''); const ans=(qItem.word||'').toLowerCase().replace(/[^a-z]/g,''); ok = user.length>0 && user===ans; }
  else{ const user=raw.replace(/\s+/g,''); if(user.length>0){ const answers=normalizeKoPieces(qItem.meaning); ok=answers.some(a=>a&&(a===user||a.includes(user)||user.includes(a))); } }

  if(ok){
    quizStats.correct++; streak++;
    feedback(el('quizFeedback'),true,'Ï†ïÎãµ!');
    playSound(streak>=3?'continuous':'correct');
    card.classList.remove('flash-correct'); void card.offsetWidth; card.classList.add('flash-correct');
    if(streak>=3) burstStars(card);
    setTimeout(()=>{ idx++; renderQuiz(); }, 450);
  }else{
    quizStats.wrong++; streak=0; quizStats.wrongItems.push(qItem);
    feedback(el('quizFeedback'),false,'Ï†ïÎãµ: ' + (qMode==='KO2EN'? qItem.word : (qItem.meaning||'-')));
    playSound('wrong');
    el('qInput').classList.remove('shake'); card.classList.remove('shake');
    void el('qInput').offsetWidth; void card.offsetWidth;
    el('qInput').classList.add('shake'); card.classList.add('shake');
    setTimeout(()=>{ idx++; renderQuiz(); }, 700);
  }
}
el('qSubmit').onclick=submitQuiz;
el('qInput').addEventListener('keydown',e=>{if(e.key==='Enter') submitQuiz();});

/* ===== Results (donut) ===== */
function drawDonut(canvas, correct, wrong){
  const dpr=Math.max(1,window.devicePixelRatio||1), cssW=canvas.width, cssH=canvas.height;
  canvas.style.width=cssW+'px'; canvas.style.height=cssH+'px'; canvas.width=cssW*dpr; canvas.height=cssH*dpr;
  const ctx=canvas.getContext('2d'), cx=canvas.width/2, cy=canvas.height/2, r=Math.min(cx,cy)-8*dpr;
  const total=Math.max(1,correct+wrong), okA=(correct/total)*Math.PI*2, wrongA=(wrong/total)*Math.PI*2;
  ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fillStyle='#F9FBF9'; ctx.fill();
  ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,-Math.PI/2,-Math.PI/2+okA); ctx.closePath(); ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--good').trim()||'#A7E9AF'; ctx.fill();
  ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,-Math.PI/2+okA,-Math.PI/2+okA+wrongA); ctx.closePath(); ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--bad').trim()||'#F7A8A8'; ctx.fill();
  ctx.beginPath(); ctx.arc(cx,cy,r*0.55,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill();
  ctx.fillStyle='#233042'; ctx.font=(20*dpr)+'px GabiaSai'; ctx.textBaseline='middle'; const pct=Math.round(correct/total*100)+'%'; const tw=ctx.measureText(pct).width; ctx.fillText(pct,cx-tw/2,cy);
}
function showQuizResult(){el('resCorrect').textContent=quizStats.correct; el('resWrong').textContent=quizStats.wrong; el('resTotal').textContent=quizStats.total; drawDonut(el('resultChart'), quizStats.correct, quizStats.wrong); switchView(el('quizResultView'));}

/* Wrong note (UTF-8 BOM) */
el('btnDownloadWrong')?.addEventListener('click',()=>{
  const lines=quizStats.wrongItems.map(w=>`${w.word} - ${w.meaning}${w.ex?` (${w.ex})`:''}`);
  const content='\ufeff'+(lines.join('\n')||'Ïò§ÎãµÏù¥ ÏóÜÏäµÎãàÎã§.');
  const blob=new Blob([content],{type:'text/plain;charset=utf-8'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`Ïò§ÎãµÎÖ∏Ìä∏_stage${stage}.txt`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
el('btnRetryWrong')?.addEventListener('click',()=>{const wrong=quizStats.wrongItems.slice(); if(!wrong.length){alert('Ïò§ÎãµÏù¥ ÏóÜÏäµÎãàÎã§.');return;} startQuizWithList(wrong);});
el('btnGoHome')?.addEventListener('click',()=>switchView(el('homeView')));

/* Nav / Flags */
el('goStudy').onclick=()=>switchView(el('studySelectView'));
el('goQuiz').onclick =()=>switchView(el('quizSelectView'));
el('titleBtn').onclick=()=>{switchView(el('homeView')); el('bottomBar').classList.add('hidden');};
el('flagUS')?.addEventListener('click',()=>{Settings.ttsLang='en-US'; updateFlagUI();});
el('flagUK')?.addEventListener('click',()=>{Settings.ttsLang='en-GB'; updateFlagUI();});

/* ===== Init ===== */
(async()=>{
  try{ data = await loadExcel(); }
  finally{
    buildStageGrid(el('studyStageGrid'), startStudy);
    buildStageGrid(el('quizStageGrid'),  startQuiz);
    updateFlagUI();
    el('loader').classList.add('hidden');
    el('app').classList.remove('hidden');
  }
})();
</script>
</body>
</html>
