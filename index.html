<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Voca Han&Hyo</title>
<link rel="icon" href="logo.png"/>

<style>
/* ===== Font ===== */
@font-face {
  font-family: 'GabiaSai';
  src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2510-1@1.0/GabiaSai-Regular.woff2') format('woff2');
  font-weight: normal;
  font-display: swap;
}

/* ===== Theme ===== */
:root{
  --primary:#58CC02; --accent:#FFD166;
  --text:#233042; --bg:#F7FAF7; --white:#fff;
  --shadow:0 6px 18px rgba(0,0,0,.08);
  --br:#E6EFE5; --br-info:#CFE0FF;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:'GabiaSai', system-ui, -apple-system, Segoe UI, Noto Sans KR, sans-serif;
  font-weight:500; -webkit-tap-highlight-color:transparent;
}
.container{max-width:900px;margin:0 auto;padding:16px 16px 120px}
.hidden{display:none!important}
.center{display:grid;place-items:center}
.spinner{width:48px;height:48px;border:5px solid #e6f4e5;border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ===== App Bar (tap ‚Üí Home) ===== */
.appbar{
  position:sticky;top:0;z-index:20;
  display:flex;align-items:center;justify-content:center;gap:8px;
  background:#fff;border-bottom:1px solid #eee;
  font-size:22px;font-weight:800;padding:10px;cursor:pointer;
}
.appbar img{width:36px;height:36px;border-radius:8px}

/* ===== Views ===== */
.view{display:none}
.view.active{display:block}

/* ===== Home ===== */
.home-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:70vh;text-align:center}
.home-logo img{width:72px;height:72px;margin-bottom:18px;border-radius:16px;box-shadow:var(--shadow)}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;width:100%;max-width:420px}
.card{
  background:#fff;border-radius:16px;padding:20px;
  box-shadow:var(--shadow);border:1px solid var(--br);
  display:flex;align-items:center;justify-content:center;gap:8px;
  font-weight:700;font-size:18px;min-height:100px;cursor:pointer;
}

/* ===== Stage Grid (centered, smaller tiles) ===== */
.stage-wrap{max-width:520px;margin:0 auto;text-align:center}
.stage-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;justify-items:center}
.stage{
  background:#fff;border-radius:10px;padding:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.06);border:1px solid var(--br);
  display:flex;align-items:center;justify-content:center;
  font-size:14px;cursor:pointer;min-height:56px;width:100%;
}

/* ===== Study ===== */
.timer{text-align:center;font-weight:800;margin:8px 0;font-size:15px}
.study-card{
  background:#fff;border-radius:16px;padding:22px;border:1px solid var(--br);
  box-shadow:var(--shadow);text-align:center;min-height:360px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px
}
.word-index{font-size:13px;opacity:.7;margin-bottom:2px}
.word{
  font-size:68px;font-weight:900;cursor:pointer;line-height:1.05;
  white-space:nowrap; /* auto-fitÏóêÏÑú Ìïú Ï§Ñ Ïú†ÏßÄ */
}
.meta{display:flex;gap:10px;align-items:center;justify-content:center;color:#555;font-size:16px}
.meaning{
  background:#FFF8EC;border:1px dashed #FFD166;padding:12px;border-radius:12px;width:100%;font-size:16px
}
.example{
  background:#F6FBFF;border:1px dashed var(--br-info);padding:12px;border-radius:12px;width:100%;
  font-size:15px;line-height:1.6;min-height:78px; /* ‚âà 3Ï§Ñ */
  display:flex;align-items:center;justify-content:center;text-align:center;
}

/* Bottom nav (Study only) */
.bottom-bar{
  position:fixed;left:0;right:0;bottom:0;z-index:30;background:#fff;border-top:1px solid #eee;
  display:flex;gap:10px;padding:10px 16px
}
.bottom-bar button{
  flex:1;border:none;border-radius:14px;padding:14px;font-size:18px;font-weight:800;
  box-shadow:var(--shadow);cursor:pointer
}
.prev-btn{background:#fff;color:var(--primary);border:2px solid var(--primary)}
.next-btn{background:var(--primary);color:#fff}

/* ===== Quiz ===== */
.quiz-wrap{display:flex;align-items:center;justify-content:center;min-height:62vh}
.quiz-card{
  background:#fff;border-radius:16px;border:1px solid var(--br);box-shadow:var(--shadow);
  padding:22px;max-width:520px;width:100%;text-align:center
}
.quiz-progress{font-weight:900;margin-bottom:6px}
.quiz-target{margin-bottom:8px}
.input-row{display:flex;gap:6px;align-items:center;justify-content:center;margin-top:10px}
.input-row input{flex:1;padding:10px 12px;border:1px solid #ccc;border-radius:10px;font-size:16px}
.btn-sm{padding:9px 12px;border:none;border-radius:10px;font-size:14px;cursor:pointer}
.btn-submit{background:#58CC02;color:#fff}
.btn-hint{background:#FFD166;color:#222}
.hint{background:#FFF8EC;border:1px dashed #FFD166;padding:10px;border-radius:10px;margin-top:10px;font-size:14px;display:none}

/* ===== Toast (top) ===== */
.toast{
  position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:100;
  background:#233042;color:#fff;padding:10px 16px;border-radius:12px;box-shadow:var(--shadow);font-size:14px;display:none
}
</style>
</head>
<body>
<div class="appbar" id="titleBtn"><img src="logo.png" alt="logo">Voca Han&Hyo</div>

<!-- Loader -->
<div id="loader" class="center" style="height:60vh"><div class="spinner" aria-label="Loading"></div></div>

<div id="app" class="container hidden">
  <!-- Home -->
  <section id="homeView" class="view active">
    <div class="home-wrap">
      <div class="home-logo"><img src="logo.png" alt="logo"></div>
      <div class="grid2">
        <button class="card" id="goStudy">üìò Study</button>
        <button class="card" id="goQuiz">üìù Quiz</button>
      </div>
    </div>
  </section>

  <!-- Stage selects (centered) -->
  <section id="studySelectView" class="view">
    <div class="stage-wrap">
      <h3>Choose a Stage</h3>
      <div class="stage-grid" id="studyStageGrid"></div>
    </div>
  </section>
  <section id="quizSelectView" class="view">
    <div class="stage-wrap">
      <h3>Choose a Stage</h3>
      <div class="stage-grid" id="quizStageGrid"></div>
    </div>
  </section>

  <!-- Study -->
  <section id="studyView" class="view">
    <div class="timer" id="studyTimer">ÎÇ®ÏùÄ ÏãúÍ∞Ñ: 30:00</div>
    <div class="study-card">
      <div class="word-index" id="wordIndex">1/150</div>
      <div class="word" id="sWord" title="Tap to hear">word</div>
      <div class="meta"><span id="sPron"></span><span id="sIpa"></span></div>
      <div class="meaning" id="sMeaning"></div>
      <div class="example" id="sExample">‚Äî</div>
    </div>
  </section>

  <!-- Quiz -->
  <section id="quizView" class="view">
    <div class="timer" id="quizTimer">ÎÇ®ÏùÄ ÏãúÍ∞Ñ: 30:00</div>
    <div class="quiz-wrap">
      <div class="quiz-card">
        <div class="quiz-progress" id="qProgress">1/150</div>
        <div class="quiz-target" id="qTarget">‚Äî</div>
        <div class="input-row">
          <input id="qInput" placeholder="Ï†ïÎãµ ÏûÖÎ†•"/>
        </div>
        <div class="input-row">
          <button class="btn-sm btn-submit" id="qSubmit">Ï†úÏ∂ú</button>
          <button class="btn-sm btn-hint" id="qHintBtn">ÌûåÌä∏</button>
        </div>
        <div class="hint" id="qHint">ÏòàÎ¨∏</div>
      </div>
    </div>
  </section>
</div>

<!-- Bottom Prev/Next for Study -->
<div class="bottom-bar hidden" id="bottomBar">
  <button class="prev-btn" id="prevBtn">‚Üê Ïù¥Ï†Ñ</button>
  <button class="next-btn" id="nextBtn">Îã§Ïùå ‚Üí</button>
</div>

<div id="toast" class="toast"></div>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
/* ===== Utilities ===== */
const el=id=>document.getElementById(id);
const showToast=msg=>{const t=el('toast');t.textContent=msg;t.style.display='block';clearTimeout(t._t);t._t=setTimeout(()=>t.style.display='none',1400);}
const fmt=s=>{const m=Math.floor(s/60),ss=s%60;return m.toString().padStart(2,'0')+":"+ss.toString().padStart(2,'0');}

/* Robust TTS: ensure voice list & select en-US when available */
let voices=[];
function loadVoices(){ voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : []; }
if('speechSynthesis' in window){
  loadVoices();
  window.speechSynthesis.onvoiceschanged = loadVoices;
}
function speak(word){
  if(!word || !('speechSynthesis' in window)) return;
  const u=new SpeechSynthesisUtterance(word);
  u.lang='en-US'; u.rate=0.95; u.pitch=1.0;
  const v = voices.find(v=>/en(-|_)?US/i.test(v.lang)) || voices.find(v=>/^en/i.test(v.lang));
  if(v) u.voice=v;
  try{ window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);}catch(e){}
}

/* ===== App State ===== */
const PER=150, STAGES=30;
const WORDS_XLSX_URL="./word_list.xlsx";
let data=[], stage=1, idx=0, timer=null, remain=1800;

/* ===== View helpers ===== */
function switchView(v){
  document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));
  v.classList.add('active');
  window.scrollTo({top:0});
}

/* ===== Stage grids ===== */
function buildStageGrid(container, onClick){
  container.innerHTML='';
  for(let i=1;i<=STAGES;i++){
    const b=document.createElement('button');
    b.className='stage';
    b.textContent=String(i).padStart(2,'0');
    b.onclick=()=>onClick(i);
    container.appendChild(b);
  }
}

/* ===== Data loader ===== */
async function loadExcel(){
  try{
    const r=await fetch(WORDS_XLSX_URL);
    if(!r.ok) throw 0;
    const ab=await r.arrayBuffer();
    const wb=XLSX.read(ab,{type:'array'});
    const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1,defval:""});
    const hdr=rows[0]||[]; const hs=new Set(hdr.map(v=>String(v).trim().toLowerCase()));
    const body=(hs.has('word')||hs.has('meaning_ko'))? rows.slice(1): rows;
    return body.map(r=>({word:(r[0]||'').toString().trim(),meaning:(r[1]||'').toString().trim(),pron:(r[2]||'').toString().trim(),ipa:(r[3]||'').toString().trim(),ex:(r[4]||'').toString().trim()})).filter(x=>x.word);
  }catch(e){
    // Demo fallback
    return [
      {word:'abandon',meaning:'Î≤ÑÎ¶¨Îã§, Ìè¨Í∏∞ÌïòÎã§',pron:'Ïñ¥Î∞¥Îçò',ipa:'…ôÀàb√¶nd…ôn',ex:'He had to abandon the plan.'},
      {word:'ability',meaning:'Îä•Î†•',pron:'Ïñ¥ÎπåÎ¶¨Ìã∞',ipa:'…ôÀàb…™l…ôti',ex:'She has the ability to lead.'},
      {word:'easily',meaning:'ÏâΩÍ≤å, Ïö©Ïù¥ÌïòÍ≤å',pron:'Ïù¥Ï¶êÎ¶¨',ipa:'ÀàiÀêz…™li',ex:'The problem can be solved easily with this method.'}
    ];
  }
}

/* ===== Timers ===== */
function startTimer(labelId){
  if(timer) clearInterval(timer);
  remain=1800;
  const t=el(labelId);
  t.textContent="ÎÇ®ÏùÄ ÏãúÍ∞Ñ: "+fmt(remain);
  timer=setInterval(()=>{
    remain--; t.textContent="ÎÇ®ÏùÄ ÏãúÍ∞Ñ: "+fmt(remain);
    if(remain<=0){ clearInterval(timer); showToast('ÏãúÍ∞Ñ Ï¢ÖÎ£å'); }
  },1000);
}

/* ===== Study ===== */
function startStudy(n){
  stage=n; idx=0;
  el('bottomBar').classList.remove('hidden');
  switchView(el('studyView'));
  startTimer('studyTimer');
  renderStudy();
}
function autoFitWord(){
  const node=el('sWord');
  let size=68, min=28;
  node.style.fontSize=size+'px';
  // Îëê Î≤à Ï†ïÎèÑ ÏãúÎèÑ: Í∞ÄÎ°ú/ÏÑ∏Î°ú Îëò Îã§ Î∞ïÏä§Ïóê ÎßûÍ≤å
  while((node.scrollWidth>node.clientWidth || node.scrollHeight>80) && size>min){
    size-=2; node.style.fontSize=size+'px';
  }
}
function renderStudy(){
  const list=data.slice((stage-1)*PER, stage*PER);
  const w=list[idx]; if(!w) return;
  el('wordIndex').textContent=(idx+1)+"/"+list.length;
  el('sWord').textContent=w.word;
  el('sPron').textContent=w.pron||'';
  el('sIpa').textContent=w.ipa||'';
  el('sMeaning').textContent=w.meaning||'';
  el('sExample').textContent=w.ex||'';
  requestAnimationFrame(autoFitWord);
}
el('sWord').addEventListener('click', ()=> speak(el('sWord').textContent));
el('prevBtn').addEventListener('click', ()=>{ idx=Math.max(0,idx-1); renderStudy(); });
el('nextBtn').addEventListener('click', ()=>{ idx++; renderStudy(); });

/* ===== Quiz (KO‚ÜîEN mix, comma partial) ===== */
function startQuiz(n){
  stage=n; idx=0;
  el('bottomBar').classList.add('hidden');
  switchView(el('quizView'));
  startTimer('quizTimer');
  renderQuiz();
}
function normalizeKoPieces(s){return (s||'').split(',').map(x=>x.replace(/\s+/g,'')).filter(Boolean);}
function renderQuiz(){
  const list=data.slice((stage-1)*PER, stage*PER);
  const w=list[idx]; if(!w){ showToast('ÌÄ¥Ï¶à Ï¢ÖÎ£å'); return;}
  const type=Math.random()<0.5?0:1; // 0: KO‚ÜíEN, 1: EN‚ÜíKO
  el('qProgress').textContent=(idx+1)+"/"+list.length;
  el('qInput').value=''; el('qHint').style.display='none';

  if(type===0){
    el('qTarget').textContent=w.meaning || 'Îúª Ï†ïÎ≥¥ ÏóÜÏùå';
    el('qHint').textContent=w.ex || 'ÏòàÎ¨∏ ÏóÜÏùå';
    el('qSubmit').onclick=()=>{
      const ok=(el('qInput').value||'').trim().toLowerCase() === (w.word||'').toLowerCase();
      showToast(ok?'Ï†ïÎãµ!':'Ïò§Îãµ: '+w.word);
      idx++; renderQuiz();
    };
  }else{
    el('qTarget').textContent=w.word || '-';
    el('qHint').textContent=w.ex || 'ÏòàÎ¨∏ ÏóÜÏùå';
    el('qSubmit').onclick=()=>{
      const user=(el('qInput').value||'').replace(/\s+/g,'');
      const answers=normalizeKoPieces(w.meaning);
      const ok=answers.some(a=>a && (a===user || a.includes(user) || user.includes(a)));
      showToast(ok?'Ï†ïÎãµ!':'Ïò§Îãµ: '+(w.meaning||'-'));
      idx++; renderQuiz();
    };
  }
}
el('qHintBtn').addEventListener('click', ()=>{ const h=el('qHint'); h.style.display=h.style.display==='none'?'block':'none'; });
el('qInput').addEventListener('keydown', e=>{ if(e.key==='Enter') el('qSubmit').click(); });

/* ===== Navigation ===== */
el('goStudy').addEventListener('click', ()=>{ switchView(el('studySelectView')); });
el('goQuiz').addEventListener('click',  ()=>{ switchView(el('quizSelectView')); });
el('titleBtn').addEventListener('click', ()=>{ switchView(el('homeView')); el('bottomBar').classList.add('hidden'); });

/* ===== Init ===== */
(async()=>{
  data = await loadExcel();
  buildStageGrid(el('studyStageGrid'), startStudy);
  buildStageGrid(el('quizStageGrid'),  startQuiz);
  el('loader').classList.add('hidden');
  el('app').classList.remove('hidden');
})();
</script>
</body>
</html>